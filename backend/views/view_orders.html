<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - View Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.6s ease-out;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #fce7f3 0%, #fff1f2 100%);
    }
    .btn-hover {
      transition: all 0.3s ease;
    }
    .btn-hover:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .table-row-hover {
      transition: all 0.2s ease;
    }
    .table-row-hover:hover {
      background-color: #fef2f2;
    }
  </style>
</head>
<body class="gradient-bg min-h-screen p-6 font-sans">
  <div class="max-w-5xl mx-auto">
    <div class="flex justify-between items-center mb-8 relative">
      <!-- Back button -->
      <button
        onclick="if (window.history.length > 1) { window.history.back(); } else { window.location.href = '/admin_dashboard.html'; }"
        class="p-2 text-rose-600 hover:text-rose-800 hover:bg-rose-50 rounded-full transition-all duration-200"
        title="Back to Dashboard"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>
      <h1 class="text-3xl md:text-4xl font-bold text-rose-700 text-center flex-1">View Orders</h1>
      <button
        onclick="localStorage.removeItem('adminToken'); window.location.href='/admin_login.html'"
        class="bg-gradient-to-r from-rose-600 to-pink-600 text-white px-4 py-2 rounded-xl font-semibold btn-hover shadow-lg"
      >
        Logout
      </button>
    </div>
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-5xl mx-auto relative overflow-hidden animate-fadeIn">
      <!-- Decorative elements -->
      <div class="absolute top-0 left-0 w-32 h-32 bg-rose-200 rounded-full -translate-x-16 -translate-y-16 opacity-50"></div>
      <div class="absolute bottom-0 right-0 w-24 h-24 bg-pink-200 rounded-full translate-x-12 translate-y-12 opacity-50"></div>

      <!-- Header -->
      <div class="text-center mb-8 relative z-10">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-rose-500 to-pink-500 rounded-full mb-4">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-rose-700 mb-2">Manage Orders</h2>
        <p class="text-rose-500 text-sm">View and update customer orders</p>
      </div>

      <!-- Orders Table -->
      <div class="relative z-10 overflow-x-auto">
        <table class="w-full text-sm text-left text-rose-700">
          <thead class="text-xs text-rose-600 uppercase bg-rose-50">
            <tr>
              <th scope="col" class="px-6 py-3">Order ID</th>
              <th scope="col" class="px-6 py-3">Customer Name</th>
              <th scope="col" class="px-6 py-3">Date</th>
              <th scope="col" class="px-6 py-3">Total (Rs.)</th>
              <th scope="col" class="px-6 py-3">Status</th>
              <th scope="col" class="px-6 py-3">Actions</th>
            </tr>
          </thead>
          <tbody id="orderTableBody">
            <!-- Orders will be populated here -->
          </tbody>
        </table>
      </div>

      <div id="message" class="hidden mt-4 bg-red-50 border border-red-200 rounded-lg p-4 flex items-center">
        <svg class="w-5 h-5 text-red-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-red-700 text-sm"></p>
      </div>
    </div>
  </div>
  <script>
    // Check if admin is logged in
    if (!localStorage.getItem('adminToken')) {
      window.location.href = '/admin_login.html';
    }

    // Function to get user ID from token
    function getUserIdFromToken() {
      const token = localStorage.getItem('adminToken');
      if (!token) return null;
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        return payload.userId || payload.id;
      } catch (e) {
        return null;
      }
    }

    // Fetch and display orders
    async function fetchOrders() {
      const messageDiv = document.getElementById('message');
      const messageText = messageDiv.querySelector('p');
      const orderTableBody = document.getElementById('orderTableBody');
      const userId = getUserIdFromToken();

      if (!userId) {
        showMessage('Error: Could not identify user', 'error');
        return;
      }

      try {
        const response = await fetch(`http://localhost:5000/api/orders/user/${userId}`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` },
        });
        const data = await response.json();
        if (response.ok) {
          orderTableBody.innerHTML = '';
          data.forEach(order => {
            const row = document.createElement('tr');
            row.classList.add('table-row-hover');
            row.innerHTML = `
              <td class="px-6 py-4">${order._id}</td>
              <td class="px-6 py-4">${order.shippingInfo?.name || 'N/A'}</td>
              <td class="px-6 py-4">${new Date(order.createdAt).toLocaleDateString()}</td>
              <td class="px-6 py-4">${order.total.toFixed(2)}</td>
              <td class="px-6 py-4">
                <select
                  class="status-select p-2 rounded-lg border border-rose-200 focus:outline-none focus:ring-2 focus:ring-rose-300 text-rose-700 bg-rose-50"
                  data-order-id="${order._id}"
                >
                  <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                  <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                  <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                  <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                </select>
              </td>
              <td class="px-6 py-4">
                <button
                  class="delete-btn text-red-500 hover:text-red-700"
                  data-order-id="${order._id}"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4a1 1 0 011 1v1H9V4a1 1 0 011-1z" />
                  </svg>
                </button>
              </td>
            `;
            orderTableBody.appendChild(row);
          });

          // Add event listeners for status updates
          document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', async (e) => {
              const orderId = e.target.dataset.orderId;
              const newStatus = e.target.value;
              try {
                const updateResponse = await fetch(`http://localhost:5000/api/orders/user/${orderId}`, {
                  method: 'PUT',
                  headers: {
                    'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ status: newStatus }),
                });
                const updateData = await updateResponse.json();
                if (updateResponse.ok) {
                  showMessage('Order status updated successfully!', 'success');
                } else {
                  showMessage(updateData.message || 'Error updating order status', 'error');
                }
              } catch (error) {
                showMessage('Error: Could not connect to server', 'error');
              }
            });
          });

          // Add event listeners for delete buttons
          document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
              const orderId = e.target.dataset.orderId || e.target.closest('button').dataset.orderId;
              if (confirm('Are you sure you want to delete this order?')) {
                try {
                  const deleteResponse = await fetch(`http://localhost:5000/api/orders/user/${orderId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` },
                  });
                  const deleteData = await deleteResponse.json();
                  if (deleteResponse.ok) {
                    showMessage('Order deleted successfully!', 'success');
                    fetchOrders(); // Refresh the table
                  } else {
                    showMessage(deleteData.message || 'Error deleting order', 'error');
                  }
                } catch (error) {
                  showMessage('Error: Could not connect to server', 'error');
                }
              }
            });
          });
        } else {
          showMessage(data.message || 'Error fetching orders', 'error');
        }
      } catch (error) {
        showMessage('Error: Could not connect to server', 'error');
      }
    }

    function showMessage(message, type) {
      const messageDiv = document.getElementById('message');
      const messageText = messageDiv.querySelector('p');
      messageDiv.classList.remove('hidden', 'bg-red-50', 'border-red-200', 'bg-green-50', 'border-green-200');
      messageText.classList.remove('text-red-700', 'text-green-700');
      messageDiv.querySelector('svg').classList.remove('text-red-500', 'text-green-500');
      if (type === 'success') {
        messageDiv.classList.add('bg-green-50', 'border-green-200');
        messageText.classList.add('text-green-700');
        messageDiv.querySelector('svg').classList.add('text-green-500');
      } else {
        messageDiv.classList.add('bg-red-50', 'border-red-200');
        messageText.classList.add('text-red-700');
        messageDiv.querySelector('svg').classList.add('text-red-500');
      }
      messageText.textContent = message;
      setTimeout(() => {
        messageDiv.classList.add('hidden');
        messageText.textContent = '';
      }, 3000);
    }

    // Fetch orders on page load
    fetchOrders();
  </script>
</body>
</html>